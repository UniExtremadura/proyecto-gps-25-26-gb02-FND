<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda - OverSound</title>
    <link rel="stylesheet" href="{{ url_for('static', path='styles/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='styles/shop.css') }}">
    <script>
        const TYA_URL = '{{ tya_server }}';
        const isAuthenticated = {{ 'true' if data.userdata else 'false' }};
    </script>
</head>
<body>
    {% include 'common/header.html' %}
    
    <main class="main-content">
        <div class="shop-container">
            <!-- Header de Tienda -->
            <div class="shop-header">
                <h1>Tienda OverSound</h1>
                <p>Descubre música exclusiva, álbumes y merchandising de tus artistas favoritos</p>
            </div>

            <!-- Filtros -->
            <div class="shop-controls">
                <div class="filters">
                    <div class="filter-group">
                        <label>Géneros:</label>
                        <div class="filter-dropdown">
                            <div class="dropdown-header" id="genre-dropdown-header">
                                <span id="genre-selected-text">Seleccionar géneros</span>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                            <div class="dropdown-content" id="genre-dropdown-content">
                                {% if genres %}
                                {% for genre in genres %}
                                <label class="dropdown-item">
                                    <input type="checkbox" class="genre-checkbox" value="{{ genre.id }}" data-name="{{ genre.name }}">
                                    <span>{{ genre.name }}</span>
                                </label>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Artistas:</label>
                        <div class="filter-dropdown">
                            <div class="dropdown-header" id="artist-dropdown-header">
                                <span id="artist-selected-text">Seleccionar artistas</span>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                            <div class="dropdown-content" id="artist-dropdown-content">
                                {% if artists %}
                                {% for artist in artists %}
                                <label class="dropdown-item">
                                    <input type="checkbox" class="artist-checkbox" value="{{ artist.artistId }}" data-name="{{ artist.artisticName }}">
                                    <span>{{ artist.artisticName }}</span>
                                </label>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="order-filter">Ordenar por:</label>
                        <select id="order-filter" class="filter-select">
                            <option value="date">Fecha</option>
                            <option value="name">Nombre</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="direction-filter">Orden:</label>
                        <select id="direction-filter" class="filter-select">
                            <option value="desc">Descendente</option>
                            <option value="asc">Ascendente</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button id="reset-filters" class="btn-reset">Limpiar Filtros</button>
                    </div>

                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <a href="/giftcard" class="btn-giftcard">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="7" width="20" height="14" rx="2"></rect>
                                <path d="M16 3v4M8 3v4M2 11h20"></path>
                            </svg>
                            Tarjetas Regalo
                        </a>
                    </div>
                </div>
            </div>

        <!-- Contenedor de Productos -->
        <div class="products-container">
            <div id="loading-indicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Cargando productos...</p>
            </div>

            <!-- Sección de Canciones -->
            <section class="products-section" id="songs-section">
                <div class="section-header">
                    <h2 class="section-title">Canciones</h2>
                    <div class="pagination-info">
                        <span id="songs-page-info"></span>
                    </div>
                </div>
                {% if songs %}
                    <div class="products-grid" id="songs-grid" data-total="{{ songs|length }}">
                        {% for song in songs %}
                            <div class="product-card" data-type="song" data-index="{{ loop.index0 }}">
                                <div class="product-image">
                                    <img src="{{ tya_server }}/static{{ song.cover if song.cover else 'img/utils/default-song.svg' }}" 
                                         alt="{{ song.name if song.name else 'Canción' }}"
                                         loading="lazy">
                                    <div class="product-overlay">
                                        <a href="/song/{{ song.song_id }}" class="btn-view">Ver Detalles</a>
                                    </div>
                                </div>
                                <div class="product-info">
                                    <h3 class="product-name">{{ song.name if song.name else 'Sin título' }}</h3>
                                    <p class="product-artist">
                                        {{ artists_map.get(song.artist, 'Artista desconocido') if song.artist else 'Artista desconocido' }}
                                    </p>
                                    {% if song.genre and genres_map.get(song.genre) %}
                                    <p class="product-genre">{{ genres_map.get(song.genre) }}</p>
                                    {% endif %}
                                    <div class="product-footer">
                                        <span class="product-price">€{{ "%.2f"|format(song.price|float) if song.price else '0.99' }}</span>
                                        <button class="btn-add-cart" data-product-id="{{ song.song_id }}" data-product-type="song">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="9" cy="21" r="1"></circle>
                                                <circle cx="20" cy="21" r="1"></circle>
                                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="pagination" id="songs-pagination"></div>
                {% else %}
                    <div class="no-products">
                        <p>No hay canciones disponibles</p>
                    </div>
                {% endif %}
            </section>

            <!-- Sección de Álbumes -->
            <section class="products-section" id="albums-section">
                <div class="section-header">
                    <h2 class="section-title">Álbumes</h2>
                    <div class="pagination-info">
                        <span id="albums-page-info"></span>
                    </div>
                </div>
                {% if albums %}
                    <div class="products-grid" id="albums-grid" data-total="{{ albums|length }}">
                        {% for album in albums %}
                            <div class="product-card" data-type="album" data-index="{{ loop.index0 }}">
                                <div class="product-image">
                                    <img src="{{ tya_server }}/static{{ album.cover if album.cover else 'img/utils/default-album.svg' }}" 
                                         alt="{{ album.name if album.name else 'Álbum' }}"
                                         loading="lazy">
                                    <div class="product-overlay">
                                        <a href="/album/{{ album.album_id }}" class="btn-view">Ver Detalles</a>
                                    </div>
                                </div>
                                <div class="product-info">
                                    <h3 class="product-name">{{ album.name if album.name else 'Sin título' }}</h3>
                                    <p class="product-artist">
                                        {{ artists_map.get(album.artist, 'Artista desconocido') if album.artist else 'Artista desconocido' }}
                                    </p>
                                    {% if album.songList %}
                                    <p class="product-meta">{{ album.songList|length }} canciones</p>
                                    {% endif %}
                                    {% if album.genre and genres_map.get(album.genre) %}
                                    <p class="product-genre">{{ genres_map.get(album.genre) }}</p>
                                    {% endif %}
                                    <div class="product-footer">
                                        <span class="product-price">€{{ "%.2f"|format(album.price|float) if album.price else '9.99' }}</span>
                                        <button class="btn-add-cart" data-product-id="{{ album.album_id }}" data-product-type="album">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="9" cy="21" r="1"></circle>
                                                <circle cx="20" cy="21" r="1"></circle>
                                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="pagination" id="albums-pagination"></div>
                {% else %}
                    <div class="no-products">
                        <p>No hay álbumes disponibles</p>
                    </div>
                {% endif %}
            </section>

            <!-- Sección de Merchandising -->
            <section class="products-section" id="merch-section">
                <div class="section-header">
                    <h2 class="section-title">Merchandising</h2>
                    <div class="pagination-info">
                        <span id="merch-page-info"></span>
                    </div>
                </div>
                {% if merch %}
                    <div class="products-grid" id="merch-grid" data-total="{{ merch|length }}">
                        {% for item in merch %}
                            <div class="product-card" data-type="merch" data-index="{{ loop.index0 }}">
                                <div class="product-image">
                                    <img src="{{ tya_server }}/static{{ item.cover if item.cover else 'img/utils/default-merch.svg' }}" 
                                         alt="{{ item.name if item.name else 'Merchandising' }}"
                                         loading="lazy">
                                    <div class="product-overlay">
                                        <a href="/merch/{{ item.merch_id }}" class="btn-view">Ver Detalles</a>
                                    </div>
                                </div>
                                <div class="product-info">
                                    <h3 class="product-name">{{ item.name if item.name else 'Sin título' }}</h3>
                                    <p class="product-artist">
                                        {{ artists_map.get(item.artist, 'Artista desconocido') if item.artist else 'Artista desconocido' }}
                                    </p>
                                    {% if item.description %}
                                    <p class="product-description">{{ item.description[:100] }}...</p>
                                    {% endif %}
                                    <div class="product-footer">
                                        <span class="product-price">€{{ "%.2f"|format(item.price|float) if item.price else '19.99' }}</span>
                                        <button class="btn-add-cart" data-product-id="{{ item.merch_id }}" data-product-type="merch">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="9" cy="21" r="1"></circle>
                                                <circle cx="20" cy="21" r="1"></circle>
                                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="pagination" id="merch-pagination"></div>
                {% else %}
                    <div class="no-products">
                        <p>No hay merchandising disponible</p>
                    </div>
                {% endif %}
            </section>

            <!-- Notificación de Carrito -->
            <div id="cart-notification" class="cart-notification" style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span id="notification-text">Producto añadido al carrito</span>
            </div>
        </div>
    </main>

    <script src="{{ url_for('static', path='js/shop.js') }}"></script>
</body>
</html>